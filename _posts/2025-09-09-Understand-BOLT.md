---
layout: post
title: BOLT原理 
tags: ["BOLT","Linker","ELF","lld", "mold", "ld", "ld.bfd", "gold"]
mathjax: true
---

# BOLT
基于论文总结。

在众多FDO中，基于采样以及在Post-link进行二进制优化。
1.	采样开销小，适用于生产环境
2.	Post-Link, 信息还原精准。

## 步骤
1.	利用函数帧以及符号表重定位表，定位函数边界以及PIC，间接调用等信息。
2.	将其反汇编为MCInst
3.	重建CFG信息以及添加注解(采样数据)
4.	运行重写流水线
  + a.	指令级别（常数加载，间接调用等）
  + b.	重排基本块，冷热分区，热路径连续，提高分支预测命中率/I-cache命中率
  + c.	函数级别，HFSort函数重排,ICF,PLT/间接跳转优化，函数分割
  + d.	寄存器/栈帧优化，移除不惜要的caller-saved寄存器移除，延迟callee-saved寄存器保存点，减少栈操作，提高局部性能


## 采样注意事项
1.	LBR 对基本块布局比对函数布局更关键，因为 BB 重排依赖精确分支信息，否则容易错位热路径。
2.	函数重排依赖调用图权重，没有 LBR 时仍有部分优化空间。
总体来说，LBR 提供的数据越精确，BOLT 的布局优化越有效且稳健。

## 总结
### BOLT 的优势
1.	后链接阶段可直接针对二进制优化
2.	代码布局优化显著改善 I-cache、I-TLB 和分支预测器压力
3.	Profile 精度高，无需回溯源代码
4.	与编译器优化互补，可叠加性能提升
   
### 适用场景
+	数据中心大规模二进制
+	前端受限严重的程序
+	需要结合静态编译优化和运行时 Profile 的场景
